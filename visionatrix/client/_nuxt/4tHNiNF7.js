import{_ as K}from"./Ce0q1BcF.js";import{_ as Q}from"./p3RRvCBJ.js";import{_ as E}from"./ioqlICsP.js";import{f as q,u as X,O as Y,H as Z,P as ee,Q as te,J as k,n as W,g as oe,K as T,N as ae,o as c,i as U,w as s,a as u,b as l,m as a,L as b,c as C,k as se,d as r,l as le,t as n,M as f,R as re,F as ne,r as ie,j as de,x as ue,p as me,I as D}from"./CvkeOVX7.js";import{_ as _e}from"./B1KGie1s.js";import{_ as ce}from"./CEcwuY70.js";import"./BQLqXII3.js";import"./D3_NRHbQ.js";const fe={class:"flex flex-col md:flex-row"},pe={class:"px-5 md:w-4/5"},ve={class:"flex flex-col lg:flex-row px-3 py-3.5 border-b border-gray-200 dark:border-gray-700"},ke={class:"flex"},ge={key:0,class:"flex flex-col md:flex-row items-center"},be={key:0},ye={class:"p-4 flex flex-wrap max-w-64 max-h-60 overflow-y-auto"},Me=q({__name:"workers",setup(we){X({title:"Workers - Visionatrix",meta:[{name:"description",content:"Workers - Visionatrix"}]});const m=Y(),L=Z();ee(()=>{m.startPolling()}),te(()=>{m.stopPolling()});const y=[{id:"worker_status",label:"Worker status",sortable:!0},{id:"id",label:"ID"},{id:"worker_id",label:"Worker ID"},{id:"worker_version",label:"Worker version",sortable:!0},{id:"last_seen",label:"Last seen",sortable:!0},{id:"tasks_to_give",label:"Tasks to give",sortable:!1},{id:"os",label:"OS",sortable:!0},{id:"version",label:"Python Version",sortable:!0},{id:"device_name",label:"Device name"},{id:"device_type",label:"Device type",sortable:!0},{id:"vram_total",label:"VRAM total",sortable:!0},{id:"vram_free",label:"VRAM free",sortable:!0},{id:"torch_vram_total",label:"Torch VRAM total",sortable:!0},{id:"torch_vram_free",label:"Torch VRAM free",sortable:!0},{id:"ram_total",label:"RAM total",sortable:!0},{id:"ram_free",label:"RAM free",sortable:!0}],g=y.map(e=>({key:e.id,label:e.label,sortable:e.sortable||!1,class:""})),M=localStorage.getItem("selectedColumns");let w=null;if(M!==null){const e=JSON.parse(M);w=g.filter(t=>e.includes(t.key)),w.sort(O)}const p=k(w||[...g]);W(p,e=>{localStorage.setItem("selectedColumns",JSON.stringify(Object.values(g).filter(t=>e.includes(t)).map(t=>t.key))),e.sort(O)});function O(e,t){return y.findIndex(d=>d.id===e.key)-y.findIndex(d=>d.id===t.key)}const x=oe(),V=T(()=>x.flows.map(e=>({label:e.display_name,value:e.name}))),_=k([]);ae(()=>{if(x.flows.length===0){x.fetchFlows().then(()=>{_.value=[...V.value]});return}_.value=[...V.value]});const h=k(!1);function N(){h.value=!0,Promise.all(i.value.map(e=>m.setTasksToGive(e.worker_id,_.value.map(t=>t.value)))).then(()=>{D().add({title:"Tasks to give updated",description:"Tasks to give updated successfully"}),i.value=[]}).catch(()=>{D().add({title:"Failed to update tasks to give",description:"Try again"})}).finally(()=>{h.value=!1,m.loadWorkers()})}const v=k(""),B=T(()=>m.$state.workers),P=T(()=>B.value.filter(e=>Object.values(e).some(t=>String(t).toLowerCase().includes(v.value.toLowerCase()))));function R(e){return new Date().getTime()-new Date(e.last_seen).getTime()<=12e4?"Online":"Offline"}const i=k([]);return W(B,e=>{if(i.value.length>0){const t=i.value.map(d=>d.id);i.value=e.filter(d=>t.includes(d.id))}}),(e,t)=>{const d=K,A=Q,$=E,F=se,G=_e,I=de,j=ue,H=re,J=ce,z=me;return c(),U(z,{class:"lg:h-dvh"},{default:s(()=>[u("div",fe,[l(d,{links:a(L).links,class:"md:w-1/5"},null,8,["links"]),u("div",pe,[t[6]||(t[6]=u("h2",{class:"mb-3 text-xl"},"Workers",-1)),u("div",ve,[u("div",ke,[l(A,{modelValue:a(p),"onUpdate:modelValue":t[0]||(t[0]=o=>b(p)?p.value=o:null),class:"mr-3",options:a(g),multiple:""},null,8,["modelValue","options"]),l($,{modelValue:a(v),"onUpdate:modelValue":t[1]||(t[1]=o=>b(v)?v.value=o:null),placeholder:"Filter workers..."},null,8,["modelValue"])]),a(i).length>=1?(c(),C("div",ge,[l(A,{modelValue:a(_),"onUpdate:modelValue":t[2]||(t[2]=o=>b(_)?_.value=o:null),class:"mr-3 my-3 lg:mx-3 lg:my-0 w-full max-w-64",options:a(V),multiple:""},{label:s(()=>t[4]||(t[4]=[u("span",null,"Tasks to give",-1)])),_:1},8,["modelValue","options"]),l(G,{text:"Flows available for worker to get tasks"},{default:s(()=>[l(F,{icon:"i-heroicons-check-16-solid",variant:"outline",color:"cyan",size:"sm",loading:a(h),onClick:N},{default:s(()=>t[5]||(t[5]=[r(" Update tasks to give ")])),_:1},8,["loading"])]),_:1})])):le("",!0)]),l(J,{modelValue:a(i),"onUpdate:modelValue":t[3]||(t[3]=o=>b(i)?i.value=o:null),columns:a(p),rows:a(v)===""?a(B):a(P),loading:a(m).$state.loading},{"worker_status-data":s(({row:o})=>[l(I,{variant:"solid",color:R(o)==="Online"?"green":"red"},{default:s(()=>[r(n(R(o)),1)]),_:2},1032,["color"])]),"tasks_to_give-data":s(({row:o})=>[o.tasks_to_give.length===0?(c(),C("span",be,"All")):(c(),U(H,{key:1,popper:{placement:"bottom"}},{panel:s(()=>[u("div",ye,[(c(!0),C(ne,null,ie(o.tasks_to_give,S=>(c(),U(I,{key:S,class:"mr-2 mb-2",variant:"solid",color:"cyan"},{default:s(()=>[l(j,{class:"hover:underline",to:`/workflows/${S}`},{default:s(()=>[r(n(S),1)]),_:2},1032,["to"])]),_:2},1024))),128))])]),default:s(()=>[l(F,{icon:"i-heroicons-list-bullet-16-solid",variant:"outline",color:"gray",size:"sm"},{default:s(()=>[u("span",null,n(o.tasks_to_give.length)+" selected",1)]),_:2},1024)]),_:2},1024))]),"last_seen-data":s(({row:o})=>[r(n(new Date(o.last_seen).toLocaleString()),1)]),"vram_total-data":s(({row:o})=>[r(n(("formatBytes"in e?e.formatBytes:a(f))(o.vram_total)),1)]),"vram_free-data":s(({row:o})=>[r(n(("formatBytes"in e?e.formatBytes:a(f))(o.vram_free)),1)]),"torch_vram_total-data":s(({row:o})=>[r(n(("formatBytes"in e?e.formatBytes:a(f))(o.torch_vram_total)),1)]),"torch_vram_free-data":s(({row:o})=>[r(n(("formatBytes"in e?e.formatBytes:a(f))(o.torch_vram_free)),1)]),"ram_total-data":s(({row:o})=>[r(n(("formatBytes"in e?e.formatBytes:a(f))(o.ram_total)),1)]),"ram_free-data":s(({row:o})=>[r(n(("formatBytes"in e?e.formatBytes:a(f))(o.ram_free)),1)]),_:1},8,["modelValue","columns","rows","loading"])])])]),_:1})}}});export{Me as default};
