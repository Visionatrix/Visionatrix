import{_ as ce}from"./C6C5sFum.js";import{a as me,_ as _e}from"./CT6QiWf4.js";import{a as pe,_ as ve}from"./X6vJFgsE.js";import{_ as fe,a as ye}from"./BT_qM-G2.js";import{f as ge,u as ke,z as be,y as Ve,q as he,S as we,T as xe,B as b,v as Q,g as Me,x as F,C as Ue,i as v,w as o,A as Ae,o as d,a as i,b as n,p as t,c as w,k as _,d as r,m as Ce,P as z,t as c,l as Re,j as Se,D as x,Q as ze,F as We,r as Be,J as Te,s as W}from"./FxB7fYMO.js";import{a as Ne,_ as De}from"./CY2D5Ww4.js";import"./DhAkBrAT.js";const Ee={class:"flex flex-col md:flex-row"},Fe={class:"px-5 md:w-4/5"},Le={key:0},Oe={class:"flex w-full items-center my-2"},Pe={class:"flex flex-col lg:flex-row px-3 py-3.5 border-b border-gray-200 dark:border-gray-700"},$e={class:"flex"},Ie={key:0,class:"flex flex-wrap flex-col md:flex-row items-center"},Ge={class:"p-4 overflow-y-auto relative"},je={class:"text-sm text-slate-500"},Ye={key:0},qe={class:"flex items-center w-full"},Je={class:"flex w-full items-center my-2"},He={key:2,class:"flex w-full items-center my-2"},Ke={class:"flex items-center w-full"},Qe={class:"flex items-center w-full"},Ze={class:"flex justify-between my-4"},Xe={key:0},et={class:"p-4 flex flex-wrap max-w-64 max-h-60 overflow-y-auto"},dt=ge({__name:"workers",setup(tt){ke({title:"Workers - Visionatrix",meta:[{name:"description",content:"Workers - Visionatrix"}]});const g=be(),m=Ve(),Z=he();we(()=>{g.startPolling()}),xe(()=>{g.stopPolling()});const L=[{id:"actions",label:"Actions",sortable:!1},{id:"worker_status",label:"Worker status",sortable:!0},{id:"federated",label:"Federated",sortable:!0},{id:"busy",label:"Busy",sortable:!0},{id:"worker_id",label:"Worker ID"},{id:"worker_version",label:"Worker version",sortable:!0},{id:"last_seen",label:"Last seen",sortable:!0},{id:"tasks_to_give",label:"Tasks to give",sortable:!1},{id:"os",label:"OS",sortable:!0},{id:"version",label:"Python Version",sortable:!0},{id:"device_name",label:"Device name"},{id:"device_type",label:"Device type",sortable:!0},{id:"vram_total",label:"VRAM total",sortable:!0},{id:"vram_free",label:"VRAM free",sortable:!0},{id:"torch_vram_total",label:"Torch VRAM total",sortable:!0},{id:"torch_vram_free",label:"Torch VRAM free",sortable:!0},{id:"ram_total",label:"RAM total",sortable:!0},{id:"ram_free",label:"RAM free",sortable:!0},{id:"smart_memory",label:"Smart memory",sortable:!0},{id:"cache_type",label:"Cache type",sortable:!0},{id:"cache_size",label:"Cache size",sortable:!0},{id:"vae_cpu",label:"VAE CPU",sortable:!0},{id:"reserve_vram",label:"Reserve VRAM (GB)",sortable:!0}],B=L.map(a=>({key:a.id,label:a.label,sortable:a.sortable||!1,class:""})),j=localStorage.getItem("selectedColumns");let O=null;if(j!==null){const a=JSON.parse(j);O=B.filter(e=>a.includes(e.key)),O.sort(Y)}const M=b(O||[...B]);Q(M,a=>{localStorage.setItem("selectedColumns",JSON.stringify(Object.values(B).filter(e=>a.includes(e)).map(e=>e.key))),a.sort(Y)});function Y(a,e){return L.findIndex(u=>u.id===a.key)-L.findIndex(u=>u.id===e.key)}const T=Me(),P=F(()=>[...T.$state.flows_installed,...T.$state.flows_available].map(a=>({label:a.display_name,value:a.name}))),k=b([]);Ue(()=>{if(T.flows.length===0){T.fetchFlows().then(()=>{k.value=[...P.value]});return}k.value=[...P.value]});const X=F(()=>k.value.length===0?"All":k.value.length),N=b(!1);function ee(){N.value=!0,Promise.all(y.value.filter(a=>a.federated_instance_name==="").map(a=>g.setTasksToGive(a.worker_id,k.value.map(e=>e.value)))).then(()=>{W().add({title:"Tasks to give updated",description:"Tasks to give updated successfully"}),y.value=[]}).catch(()=>{W().add({title:"Failed to update tasks to give",description:"Try again"})}).finally(()=>{N.value=!1,g.loadWorkers()})}const U=b(""),$=F(()=>g.$state.workers),te=F(()=>$.value.filter(a=>Object.values(a).some(e=>String(e).toLowerCase().includes(U.value.toLowerCase()))));function q(a){const e=new Date(a.last_seen.includes("Z")?a.last_seen:a.last_seen+"Z");return new Date().getTime()-e.getTime()<=60*5*1e3?"Online":"Offline"}const y=b([]);Q($,a=>{if(y.value.length>0){const e=y.value.map(u=>u.worker_id);y.value=a.filter(u=>e.includes(u.worker_id))}});const le=["smart_memory","cache_type","cache_size","vae_cpu","reserve_vram"],J=b(!1);function oe(){J.value=!0,m.saveChanges(le).finally(()=>{J.value=!1})}const A=b(!1),s=b(null),ae=a=>{s.value=a,A.value=!0},I=()=>{A.value=!1,s.value=null},C=b(!1),se=()=>{s.value&&(C.value=!0,g.updateWorkerOptions(s.value.worker_id,{smart_memory:s.value.smart_memory??null,cache_type:s.value.cache_type??null,cache_size:s.value.cache_size??null,vae_cpu:s.value.vae_cpu??null,reserve_vram:s.value.reserve_vram??null}).then(()=>{W().add({title:"Worker options updated",description:"Worker options updated successfully"}),g.loadWorkers()}).catch(()=>{W().add({title:"Failed to update worker options",description:"Try again"})}).finally(()=>{C.value=!1,I()}))},H=a=>{const e=W();g.deleteWorker(a).then(u=>{if(u!=null&&u.detail){e.add({title:"Failed to delete worker",description:u.detail});return}e.add({title:"Worker deleted",description:"Worker deleted successfully"})}).catch(u=>{e.add({title:"Failed to delete worker",description:`Error: ${(u==null?void 0:u.detail)||"Unknown error"}`})}).finally(()=>{g.loadWorkers()})};return(a,e)=>{const u=ce,G=me,D=pe,V=_e,E=fe,R=ve,p=Ce,K=Re,S=ye,ne=Ne,h=Se,re=Te,ie=ze,de=De,ue=Ae;return d(),v(ue,{class:"lg:h-dvh"},{default:o(()=>[i("div",Ee,[n(u,{links:t(m).links,class:"md:w-1/5"},null,8,["links"]),i("div",Fe,[e[34]||(e[34]=i("h2",{class:"mb-3 text-xl"},"Workers",-1)),t(Z).isAdmin?(d(),w("div",Le,[n(G,{class:"mb-3",label:"Default Workers settings"}),n(V,{size:"md",class:"py-3",label:"Smart memory",description:"When disabled forces ComfyUI to aggressively offload to regular RAM instead of keeping models in VRAM when it can."},{default:o(()=>[n(D,{modelValue:t(m).settingsMap.smart_memory.value,"onUpdate:modelValue":e[0]||(e[0]=l=>t(m).settingsMap.smart_memory.value=l),color:"primary",class:"py-3",label:"Enable smart memory"},null,8,["modelValue"])]),_:1}),n(V,{size:"md",class:"py-3",label:"Cache type"},{description:o(()=>e[24]||(e[24]=[i("p",null,[r(" Classic - Use the old style (aggressive) caching. "),i("br"),r(" LRU - Use LRU caching with a maximum of N node results cached. May use more RAM/VRAM. "),i("br"),r(" None - Reduced RAM/VRAM usage at the expense of executing every node for each run. "),i("br")],-1)])),default:o(()=>[i("div",Oe,[n(E,{modelValue:t(m).settingsMap.cache_type.value,"onUpdate:modelValue":e[1]||(e[1]=l=>t(m).settingsMap.cache_type.value=l),class:"w-fit",placeholder:"Select cache type","value-attribute":"value",options:t(m).settingsMap.cache_type.options},null,8,["modelValue","options"])]),t(m).settingsMap.cache_type.value==="lru"?(d(),v(R,{key:0,modelValue:t(m).settingsMap.cache_size.value,"onUpdate:modelValue":e[2]||(e[2]=l=>t(m).settingsMap.cache_size.value=l),type:"number",class:"w-fit",min:"1",onChange:e[3]||(e[3]=()=>{t(m).settingsMap.cache_size.value=t(m).settingsMap.cache_size.value.toString()})},null,8,["modelValue"])):_("",!0)]),_:1}),n(V,{size:"md",class:"py-3",label:"VAE cpu",description:"Run the VAE on the CPU."},{default:o(()=>[n(D,{modelValue:t(m).settingsMap.vae_cpu.value,"onUpdate:modelValue":e[4]||(e[4]=l=>t(m).settingsMap.vae_cpu.value=l),color:"primary",class:"py-3",label:"VAE on CPU"},null,8,["modelValue"])]),_:1}),n(V,{size:"md",class:"py-3",label:"Reserve VRAM",description:"Amount of VRAM in GB to reserve for use by other software (total VRAM = total VRAM - reserve VRAM)."},{default:o(()=>[n(R,{modelValue:t(m).settingsMap.reserve_vram.value,"onUpdate:modelValue":e[5]||(e[5]=l=>t(m).settingsMap.reserve_vram.value=l),type:"number",min:"0",step:"0.1",class:"w-fit"},null,8,["modelValue"])]),_:1}),n(p,{class:"mt-3",icon:"i-heroicons-check-16-solid",loading:t(C),onClick:oe},{default:o(()=>e[25]||(e[25]=[r(" Save ")])),_:1,__:[25]},8,["loading"])])):_("",!0),n(G,{class:"my-3"}),i("div",Pe,[i("div",$e,[n(E,{modelValue:t(M),"onUpdate:modelValue":e[6]||(e[6]=l=>z(M)?M.value=l:null),class:"mr-3",options:t(B),multiple:""},null,8,["modelValue","options"]),n(R,{modelValue:t(U),"onUpdate:modelValue":e[7]||(e[7]=l=>z(U)?U.value=l:null),placeholder:"Filter workers..."},null,8,["modelValue"])]),t(y).length>=1?(d(),w("div",Ie,[n(E,{modelValue:t(k),"onUpdate:modelValue":e[8]||(e[8]=l=>z(k)?k.value=l:null),searchable:"",class:"mr-3 my-3 lg:mx-3 lg:my-0 w-full max-w-64 min-w-64",options:t(P),multiple:""},{label:o(()=>[i("span",null,"Tasks to give ("+c(t(X))+")",1)]),_:1},8,["modelValue","options"]),n(K,{text:"Flows available for worker to get tasks"},{default:o(()=>[n(p,{icon:"i-heroicons-check-16-solid",variant:"outline",color:"cyan",size:"sm",loading:t(N),onClick:ee},{default:o(()=>e[26]||(e[26]=[r(" Update tasks to give ")])),_:1,__:[26]},8,["loading"])]),_:1}),n(p,{icon:"i-heroicons-x-mark",variant:"outline",color:"white",class:"mx-2",onClick:e[9]||(e[9]=()=>{k.value=[]})}),n(K,{text:"Delete selected workers"},{default:o(()=>[n(p,{icon:"i-heroicons-trash-16-solid",variant:"outline",color:"red",size:"sm",loading:t(C),onClick:e[10]||(e[10]=()=>{t(y).length>0&&H(t(y).map(l=>l.worker_id)),y.value=[]})},{default:o(()=>e[27]||(e[27]=[r(" Delete ")])),_:1,__:[27]},8,["loading"])]),_:1})])):_("",!0)]),n(ne,{modelValue:t(A),"onUpdate:modelValue":e[22]||(e[22]=l=>z(A)?A.value=l:null),transition:!1},{default:o(()=>{var l;return[i("div",Ge,[e[32]||(e[32]=i("h2",{class:"font-bold"},"Individual worker configuration options",-1)),i("p",je,c((l=t(s))==null?void 0:l.worker_id),1),t(s)?(d(),w("div",Ye,[n(V,{size:"md",class:"py-3",label:"Smart memory",description:"When disabled forces ComfyUI to aggressively offload to regular RAM instead of keeping models in VRAM when it can."},{default:o(()=>[t(s).smart_memory===null?(d(),v(S,{key:0,color:"cyan",variant:"soft",title:"Not set",class:"mb-2"})):_("",!0),i("div",qe,[n(D,{modelValue:t(s).smart_memory,"onUpdate:modelValue":e[11]||(e[11]=f=>t(s).smart_memory=f),color:"primary",class:"py-3",label:"Enable smart memory"},null,8,["modelValue"]),t(s).smart_memory?(d(),v(p,{key:0,icon:"i-heroicons-x-mark",variant:"outline",color:"white",class:"ml-2",onClick:e[12]||(e[12]=()=>{t(s)&&(t(s).smart_memory=null)})})):_("",!0)])]),_:1}),n(V,{size:"md",class:"py-3",label:"Cache type"},{description:o(()=>e[28]||(e[28]=[i("p",null,[r(" Classic - Use the old style (aggressive) caching. "),i("br"),r(" LRU - Use LRU caching with a maximum of N node results cached. May use more RAM/VRAM. "),i("br"),r(" None - Reduced RAM/VRAM usage at the expense of executing every node for each run. "),i("br")],-1)])),default:o(()=>[t(s).cache_type===null?(d(),v(S,{key:0,color:"cyan",variant:"soft",title:"Not set",class:"mb-2"})):_("",!0),i("div",Je,[n(E,{modelValue:t(s).cache_type,"onUpdate:modelValue":e[13]||(e[13]=f=>t(s).cache_type=f),class:"w-fit",placeholder:"Select cache type","value-attribute":"value",options:t(m).settingsMap.cache_type.options},null,8,["modelValue","options"]),t(s).cache_type!==null?(d(),v(p,{key:0,icon:"i-heroicons-x-mark",variant:"outline",color:"white",class:"ml-2",onClick:e[14]||(e[14]=()=>{t(s)&&(t(s).cache_type=null)})})):_("",!0)]),t(s).cache_type==="lru"&&t(s).cache_size===null?(d(),v(S,{key:1,color:"cyan",variant:"soft",title:"Not set",class:"mb-2"})):_("",!0),t(s).cache_type==="lru"?(d(),w("div",He,[n(R,{modelValue:t(s).cache_size,"onUpdate:modelValue":e[15]||(e[15]=f=>t(s).cache_size=f),type:"number",class:"w-fit",min:"1"},null,8,["modelValue"]),t(s).cache_size!==null?(d(),v(p,{key:0,icon:"i-heroicons-x-mark",variant:"outline",color:"white",class:"ml-2",onClick:e[16]||(e[16]=()=>{t(s)&&(t(s).cache_size=null)})})):_("",!0)])):_("",!0)]),_:1}),n(V,{size:"md",class:"py-3",label:"VAE cpu",description:"Run the VAE on the CPU."},{default:o(()=>[t(s).vae_cpu===null?(d(),v(S,{key:0,color:"cyan",variant:"soft",title:"Not set",class:"mb-2"})):_("",!0),i("div",Ke,[n(D,{modelValue:t(s).vae_cpu,"onUpdate:modelValue":e[17]||(e[17]=f=>t(s).vae_cpu=f),color:"primary",class:"py-3",label:"VAE on CPU"},null,8,["modelValue"]),t(s).vae_cpu?(d(),v(p,{key:0,icon:"i-heroicons-x-mark",variant:"outline",color:"white",class:"ml-2",onClick:e[18]||(e[18]=()=>{t(s)&&(t(s).vae_cpu=null)})})):_("",!0)])]),_:1}),n(V,{size:"md",class:"py-3",label:"Reserve VRAM",description:"Amount of VRAM in GB to reserve for use."},{default:o(()=>[t(s).reserve_vram===null?(d(),v(S,{key:0,color:"cyan",variant:"soft",title:"Not set",class:"mb-2"})):_("",!0),i("div",Qe,[n(R,{modelValue:t(s).reserve_vram,"onUpdate:modelValue":e[19]||(e[19]=f=>t(s).reserve_vram=f),type:"number",min:"0",step:"0.1",class:"w-fit"},null,8,["modelValue"]),t(s).reserve_vram!==null?(d(),v(p,{key:0,icon:"i-heroicons-x-mark",variant:"outline",color:"white",class:"ml-2",onClick:e[20]||(e[20]=()=>{t(s)&&(t(s).reserve_vram=null)})})):_("",!0)])]),_:1})])):_("",!0),i("div",Ze,[i("div",null,[n(p,{variant:"solid",icon:"i-heroicons-trash-16-solid",color:"red",loading:t(C),onClick:e[21]||(e[21]=()=>{t(s)&&H([t(s).worker_id]),I()})},{default:o(()=>e[29]||(e[29]=[r(" Delete worker ")])),_:1,__:[29]},8,["loading"])]),i("div",null,[n(p,{class:"mr-2",variant:"solid",color:"green",loading:t(N),onClick:se},{default:o(()=>e[30]||(e[30]=[r(" Save ")])),_:1,__:[30]},8,["loading"]),n(p,{class:"mr-2",variant:"solid",color:"white",onClick:I},{default:o(()=>e[31]||(e[31]=[r(" Cancel ")])),_:1,__:[31]})])])])]}),_:1},8,["modelValue"]),n(de,{modelValue:t(y),"onUpdate:modelValue":e[23]||(e[23]=l=>z(y)?y.value=l:null),columns:t(M),rows:t(U)===""?t($):t(te),loading:t(g).$state.loading},{"actions-data":o(({row:l})=>[n(p,{icon:"i-heroicons-pencil-16-solid",variant:"outline",color:"cyan",size:"sm",onClick:()=>{ae(l)}},{default:o(()=>e[33]||(e[33]=[r(" Edit ")])),_:2,__:[33]},1032,["onClick"])]),"worker_status-data":o(({row:l})=>[n(h,{variant:"solid",color:q(l)==="Online"?"green":"red"},{default:o(()=>[r(c(q(l)),1)]),_:2},1032,["color"])]),"federated-data":o(({row:l})=>[n(h,{variant:"solid",color:l.federated_instance_name!==""?"blue":"green"},{default:o(()=>[r(c(l.federated_instance_name!==""?"Yes":"No"),1)]),_:2},1032,["color"])]),"busy-data":o(({row:l})=>[n(h,{variant:"solid",color:l.empty_task_requests_count===0?"red":"green"},{default:o(()=>[r(c(l.empty_task_requests_count===0?"Yes":"No"),1)]),_:2},1032,["color"])]),"tasks_to_give-data":o(({row:l})=>[l.tasks_to_give.length===0?(d(),w("span",Xe,"All")):(d(),v(ie,{key:1,popper:{placement:"bottom"}},{panel:o(()=>[i("div",et,[(d(!0),w(We,null,Be(l.tasks_to_give,f=>(d(),v(h,{key:f,class:"mr-2 mb-2",variant:"solid",color:"cyan"},{default:o(()=>[n(re,{class:"hover:underline",to:`/workflows/${f}`},{default:o(()=>[r(c(f),1)]),_:2},1032,["to"])]),_:2},1024))),128))])]),default:o(()=>[n(p,{icon:"i-heroicons-list-bullet-16-solid",variant:"outline",color:"gray",size:"sm"},{default:o(()=>[i("span",null,c(l.tasks_to_give.length)+" selected",1)]),_:2},1024)]),_:2},1024))]),"last_seen-data":o(({row:l})=>[r(c(new Date(l.last_seen).toLocaleString()),1)]),"vram_total-data":o(({row:l})=>[r(c(("formatBytes"in a?a.formatBytes:t(x))(l.vram_total)),1)]),"vram_free-data":o(({row:l})=>[r(c(("formatBytes"in a?a.formatBytes:t(x))(l.vram_free)),1)]),"torch_vram_total-data":o(({row:l})=>[r(c(("formatBytes"in a?a.formatBytes:t(x))(l.torch_vram_total)),1)]),"torch_vram_free-data":o(({row:l})=>[r(c(("formatBytes"in a?a.formatBytes:t(x))(l.torch_vram_free)),1)]),"ram_total-data":o(({row:l})=>[r(c(("formatBytes"in a?a.formatBytes:t(x))(l.ram_total)),1)]),"ram_free-data":o(({row:l})=>[r(c(("formatBytes"in a?a.formatBytes:t(x))(l.ram_free)),1)]),"smart_memory-data":o(({row:l})=>[n(h,{variant:"solid",color:l.engine_details.disable_smart_memory?"red":"green"},{default:o(()=>[r(c(l.engine_details.disable_smart_memory?"No":"Yes"),1)]),_:2},1032,["color"])]),"cache_type-data":o(({row:l})=>[n(h,{variant:"solid",color:l.engine_details.cache_type==="none"?"red":"green"},{default:o(()=>[r(c(l.engine_details.cache_type??"N/A"),1)]),_:2},1032,["color"])]),"cache_size-data":o(({row:l})=>[r(c(l.engine_details.cache_size&&l.engine_details.cache_type==="lru"?l.engine_details.cache_size+" nodes":"N/A"),1)]),"vae_cpu-data":o(({row:l})=>[n(h,{variant:"solid",color:l.engine_details.vae_cpu?"green":"red"},{default:o(()=>[r(c(l.engine_details.vae_cpu?"Yes":"No"),1)]),_:2},1032,["color"])]),"reserve_vram-data":o(({row:l})=>[r(c(l.engine_details.reserve_vram??"N/A"),1)]),_:1},8,["modelValue","columns","rows","loading"])])])]),_:1})}}});export{dt as default};
