import{_ as Q}from"./DIicaaYA.js";import{_ as Y}from"./B7OzIgmV.js";import{_ as Z}from"./B5yPpNeP.js";import{f as E,u as K,z as X,y as ee,S as te,T as oe,B as k,v as R,g as ae,x as w,C as se,i as D,w as a,A as le,o as _,a as m,b as l,p as s,c as F,k as ne,P as x,t as n,l as re,m as ie,d as r,D as f,Q as de,F as ue,r as me,j as ce,J as _e,s as W}from"./WHgTFjnX.js";import{_ as fe}from"./DsZImONT.js";import"./CjZld9f2.js";import"./BZYMDSx_.js";const pe={class:"flex flex-col md:flex-row"},ve={class:"px-5 md:w-4/5"},ke={class:"flex flex-col lg:flex-row px-3 py-3.5 border-b border-gray-200 dark:border-gray-700"},be={class:"flex"},ge={key:0,class:"flex flex-col md:flex-row items-center"},ye={key:0},we={class:"p-4 flex flex-wrap max-w-64 max-h-60 overflow-y-auto"},Ae=E({__name:"workers",setup(xe){K({title:"Workers - Visionatrix",meta:[{name:"description",content:"Workers - Visionatrix"}]});const c=X(),L=ee();te(()=>{c.startPolling()}),oe(()=>{c.stopPolling()});const h=[{id:"worker_status",label:"Worker status",sortable:!0},{id:"federated",label:"Federated",sortable:!0},{id:"busy",label:"Busy",sortable:!0},{id:"worker_id",label:"Worker ID"},{id:"worker_version",label:"Worker version",sortable:!0},{id:"last_seen",label:"Last seen",sortable:!0},{id:"tasks_to_give",label:"Tasks to give",sortable:!1},{id:"os",label:"OS",sortable:!0},{id:"version",label:"Python Version",sortable:!0},{id:"device_name",label:"Device name"},{id:"device_type",label:"Device type",sortable:!0},{id:"vram_total",label:"VRAM total",sortable:!0},{id:"vram_free",label:"VRAM free",sortable:!0},{id:"torch_vram_total",label:"Torch VRAM total",sortable:!0},{id:"torch_vram_free",label:"Torch VRAM free",sortable:!0},{id:"ram_total",label:"RAM total",sortable:!0},{id:"ram_free",label:"RAM free",sortable:!0}],b=h.map(e=>({key:e.id,label:e.label,sortable:e.sortable||!1,class:""})),M=localStorage.getItem("selectedColumns");let T=null;if(M!==null){const e=JSON.parse(M);T=b.filter(o=>e.includes(o.key)),T.sort(O)}const p=k(T||[...b]);R(p,e=>{localStorage.setItem("selectedColumns",JSON.stringify(Object.values(b).filter(o=>e.includes(o)).map(o=>o.key))),e.sort(O)});function O(e,o){return h.findIndex(i=>i.id===e.key)-h.findIndex(i=>i.id===o.key)}const g=ae(),V=w(()=>[...g.$state.flows_installed,...g.$state.flows_available].map(e=>({label:e.display_name,value:e.name}))),d=k([]);se(()=>{if(g.flows.length===0){g.fetchFlows().then(()=>{d.value=[...V.value]});return}d.value=[...V.value]});const I=w(()=>d.value.length===0?"All":d.value.length),B=k(!1);function $(){B.value=!0,Promise.all(u.value.filter(e=>e.federated_instance_name==="").map(e=>c.setTasksToGive(e.worker_id,d.value.map(o=>o.value)))).then(()=>{W().add({title:"Tasks to give updated",description:"Tasks to give updated successfully"}),u.value=[]}).catch(()=>{W().add({title:"Failed to update tasks to give",description:"Try again"})}).finally(()=>{B.value=!1,c.loadWorkers()})}const v=k(""),S=w(()=>c.$state.workers),P=w(()=>S.value.filter(e=>Object.values(e).some(o=>String(o).toLowerCase().includes(v.value.toLowerCase()))));function N(e){const o=new Date(e.last_seen.includes("Z")?e.last_seen:e.last_seen+"Z");return new Date().getTime()-o.getTime()<=60*5*1e3?"Online":"Offline"}const u=k([]);return R(S,e=>{if(u.value.length>0){const o=u.value.map(i=>i.worker_id);u.value=e.filter(i=>o.includes(i.worker_id))}}),(e,o)=>{const i=Q,C=Y,G=Z,U=ie,j=re,y=ce,z=_e,J=de,q=fe,H=le;return _(),D(H,{class:"lg:h-dvh"},{default:a(()=>[m("div",pe,[l(i,{links:s(L).links,class:"md:w-1/5"},null,8,["links"]),m("div",ve,[o[6]||(o[6]=m("h2",{class:"mb-3 text-xl"},"Workers",-1)),m("div",ke,[m("div",be,[l(C,{modelValue:s(p),"onUpdate:modelValue":o[0]||(o[0]=t=>x(p)?p.value=t:null),class:"mr-3",options:s(b),multiple:""},null,8,["modelValue","options"]),l(G,{modelValue:s(v),"onUpdate:modelValue":o[1]||(o[1]=t=>x(v)?v.value=t:null),placeholder:"Filter workers..."},null,8,["modelValue"])]),s(u).length>=1?(_(),F("div",ge,[l(C,{modelValue:s(d),"onUpdate:modelValue":o[2]||(o[2]=t=>x(d)?d.value=t:null),searchable:"",class:"mr-3 my-3 lg:mx-3 lg:my-0 w-full max-w-64 min-w-64",options:s(V),multiple:""},{label:a(()=>[m("span",null,"Tasks to give ("+n(s(I))+")",1)]),_:1},8,["modelValue","options"]),l(j,{text:"Flows available for worker to get tasks"},{default:a(()=>[l(U,{icon:"i-heroicons-check-16-solid",variant:"outline",color:"cyan",size:"sm",loading:s(B),onClick:$},{default:a(()=>o[5]||(o[5]=[r(" Update tasks to give ")])),_:1},8,["loading"])]),_:1}),l(U,{icon:"i-heroicons-x-mark",variant:"outline",color:"white",class:"ml-2",onClick:o[3]||(o[3]=()=>{d.value=[]})})])):ne("",!0)]),l(q,{modelValue:s(u),"onUpdate:modelValue":o[4]||(o[4]=t=>x(u)?u.value=t:null),columns:s(p),rows:s(v)===""?s(S):s(P),loading:s(c).$state.loading},{"worker_status-data":a(({row:t})=>[l(y,{variant:"solid",color:N(t)==="Online"?"green":"red"},{default:a(()=>[r(n(N(t)),1)]),_:2},1032,["color"])]),"federated-data":a(({row:t})=>[l(y,{variant:"solid",color:t.federated_instance_name!==""?"blue":"green"},{default:a(()=>[r(n(t.federated_instance_name!==""?"Yes":"No"),1)]),_:2},1032,["color"])]),"busy-data":a(({row:t})=>[l(y,{variant:"solid",color:t.empty_task_requests_count===0?"red":"green"},{default:a(()=>[r(n(t.empty_task_requests_count===0?"Yes":"No"),1)]),_:2},1032,["color"])]),"tasks_to_give-data":a(({row:t})=>[t.tasks_to_give.length===0?(_(),F("span",ye,"All")):(_(),D(J,{key:1,popper:{placement:"bottom"}},{panel:a(()=>[m("div",we,[(_(!0),F(ue,null,me(t.tasks_to_give,A=>(_(),D(y,{key:A,class:"mr-2 mb-2",variant:"solid",color:"cyan"},{default:a(()=>[l(z,{class:"hover:underline",to:`/workflows/${A}`},{default:a(()=>[r(n(A),1)]),_:2},1032,["to"])]),_:2},1024))),128))])]),default:a(()=>[l(U,{icon:"i-heroicons-list-bullet-16-solid",variant:"outline",color:"gray",size:"sm"},{default:a(()=>[m("span",null,n(t.tasks_to_give.length)+" selected",1)]),_:2},1024)]),_:2},1024))]),"last_seen-data":a(({row:t})=>[r(n(new Date(t.last_seen).toLocaleString()),1)]),"vram_total-data":a(({row:t})=>[r(n(("formatBytes"in e?e.formatBytes:s(f))(t.vram_total)),1)]),"vram_free-data":a(({row:t})=>[r(n(("formatBytes"in e?e.formatBytes:s(f))(t.vram_free)),1)]),"torch_vram_total-data":a(({row:t})=>[r(n(("formatBytes"in e?e.formatBytes:s(f))(t.torch_vram_total)),1)]),"torch_vram_free-data":a(({row:t})=>[r(n(("formatBytes"in e?e.formatBytes:s(f))(t.torch_vram_free)),1)]),"ram_total-data":a(({row:t})=>[r(n(("formatBytes"in e?e.formatBytes:s(f))(t.ram_total)),1)]),"ram_free-data":a(({row:t})=>[r(n(("formatBytes"in e?e.formatBytes:s(f))(t.ram_free)),1)]),_:1},8,["modelValue","columns","rows","loading"])])])]),_:1})}}});export{Ae as default};
